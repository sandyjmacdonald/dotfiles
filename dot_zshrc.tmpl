# ~/.zshrc  â€” interactive shell config (managed by chezmoi)

# ---- Viking HPC fallback for interactive non-login shells ----
if [[ $- == *i* ]]; then
  if [ "$(uname -s)" = "Linux" ]; then
    host_lc="$(hostname 2>/dev/null | tr '[:upper:]' '[:lower:]')"
    if [[ "$host_lc" == *viking* ]]; then
      for f in \
        /etc/profile.d/lmod.sh \
        /etc/profile.d/modules.sh \
        /usr/share/Modules/init/zsh \
        /usr/share/Modules/init/profile.zsh \
        /usr/share/lmod/lmod/init/zsh \
        /usr/share/lmod/lmod/init/profile; do
        [ -f "$f" ] && . "$f"
      done
      if command -v module >/dev/null 2>&1 && ! command -v nvim >/dev/null 2>&1; then
        if module -t avail 2>&1 | grep -qE '^Neovim/0\.11\.4'; then
          module load Neovim/0.11.4-GCCcore-13.2.0 >/dev/null 2>&1 || true
          hash -r
        fi
      fi
    fi
  fi
fi

# ---- Ensure Homebrew & ~/.local/bin are on PATH (even for non-login shells) ----
[ -x /opt/homebrew/bin/brew ] && eval "$(/opt/homebrew/bin/brew shellenv)"
[ -x /usr/local/bin/brew ]    && eval "$(/usr/local/bin/brew shellenv)"
case ":$PATH:" in (*":$HOME/.local/bin:"*) ;; (*) export PATH="$HOME/.local/bin:$PATH" ;; esac

# ---- History ----
HISTFILE=${HISTFILE:-$HOME/.zsh_history}
HISTSIZE=100000
SAVEHIST=100000

# ---- Plugins via Homebrew (guarded) ----
if command -v brew >/dev/null 2>&1; then
  BREW_PREFIX="$(brew --prefix)"
  FPATH="$BREW_PREFIX/share/zsh/site-functions:${FPATH}"

  # 1) autosuggestions
  [ -f "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ] \
    && source "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"

  # 2) history-substring-search (+ keys)
  if [ -f "$BREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh" ]; then
    source "$BREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh"
    bindkey '^[[A' history-substring-search-up
    bindkey '^[[B' history-substring-search-down
  fi

  # 3) syntax-highlighting last
  [ -f "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ] \
    && source "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# ---- fzf keybindings/completions ----
[ -f "$HOME/.fzf.zsh" ] && source "$HOME/.fzf.zsh"

# ---- Prompt & navigation ----
command -v zoxide   >/dev/null 2>&1 && eval "$(zoxide init zsh)"
command -v starship >/dev/null 2>&1 && eval "$(starship init zsh)"

# ---- Shared aliases & functions ----
[ -f "$HOME/.config/shell/aliases.sh" ] && source "$HOME/.config/shell/aliases.sh"

# ---- Optional local overrides not managed by chezmoi ----
[ -f "$HOME/.zshrc.local" ] && source "$HOME/.zshrc.local"

# ---- Fastfetch (macOS only; once per new local interactive terminal) ----
{{ if eq .chezmoi.os "darwin" }}
if [[ $- == *i* ]] && command -v fastfetch >/dev/null 2>&1; then
  # Skip inside tmux or SSH sessions
  if [[ -z ${TMUX-} && -z ${SSH_TTY-} ]]; then
    if [[ -z ${FASTFETCH_SHOWN-} ]]; then
      FASTFETCH_SHOWN=1
      fastfetch 2>/dev/null || true
    fi
  fi
fi
{{ end }}
